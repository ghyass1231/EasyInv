<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>EasyInv - Inventaire</title>
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#dc2626">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-title" content="EasyInv">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            margin: 0;
            overflow: auto;
        }

        html {
            height: -webkit-fill-available;
        }

        .header {
            background: white;
            padding: 10px 12px;
            border-radius: 12px 12px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo {
            height: 30px;
            width: auto;
        }

        .app-title {
            font-size: 18px;
            font-weight: 700;
            color: #dc2626;
            letter-spacing: 0.5px;
        }

        .header-buttons {
            display: flex;
            gap: 8px;
        }

        .settings-btn, .fullscreen-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(220, 38, 38, 0.3);
        }

        .settings-btn:hover, .fullscreen-btn:hover {
            background: #b91c1c;
            transform: scale(1.05);
        }

        .settings-btn.active, .fullscreen-btn.active {
            background: #991b1b;
        }

        /* Settings Sidebar */
        .settings-sidebar {
            position: fixed;
            right: -350px;
            top: 0;
            width: 350px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.3);
            transition: right 0.3s ease;
            z-index: 2000;
            overflow-y: auto;
            padding: 20px;
        }

        .settings-sidebar.open {
            right: 0;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #fecaca;
        }

        .settings-title {
            font-size: 18px;
            font-weight: 700;
            color: #dc2626;
        }

        .close-settings {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #991b1b;
        }

        .settings-section {
            margin-bottom: 25px;
        }

        .settings-section-title {
            font-size: 13px;
            font-weight: 600;
            color: #991b1b;
            text-transform: uppercase;
            margin-bottom: 12px;
            letter-spacing: 0.5px;
        }

        .settings-field {
            margin-bottom: 12px;
        }

        .settings-field label {
            display: block;
            font-size: 12px;
            color: #374151;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .settings-field input[type="text"],
        .settings-field input[type="url"] {
            width: 100%;
            padding: 8px;
            border: 2px solid #fecaca;
            border-radius: 6px;
            font-size: 13px;
            background: #fef2f2;
        }

        .settings-field input:focus {
            outline: none;
            border-color: #dc2626;
            background: white;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #fef2f2;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-group label {
            font-size: 13px;
            color: #374151;
            cursor: pointer;
            margin: 0;
        }

        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 780px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .content {
            padding: 12px;
            overflow-y: auto;
            flex: 1;
        }

        .form-group {
            margin-bottom: 8px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        label {
            display: block;
            color: #991b1b;
            font-weight: 600;
            margin-bottom: 3px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        input[type="text"] {
            width: 100%;
            padding: 7px 8px;
            border: 2px solid #fecaca;
            border-radius: 6px;
            font-size: 13px;
            transition: all 0.3s ease;
            -webkit-appearance: none;
            background: #fef2f2;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #dc2626;
            background: white;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        .count-display {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            margin: 10px 0;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .count-label {
            font-size: 11px;
            opacity: 0.95;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .count-value {
            font-size: 24px;
            font-weight: bold;
        }

        .btn {
            width: 100%;
            padding: 10px;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 44px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            margin-bottom: 8px;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
        }

        .current-location {
            background: #fef2f2;
            border-left: 4px solid #dc2626;
            padding: 8px;
            margin: 8px 0;
            border-radius: 6px;
            color: #991b1b;
            font-size: 11px;
            font-weight: 500;
        }

        .product-list {
            background: #f9fafb;
            border-radius: 6px;
            padding: 8px;
            margin-top: 8px;
            max-height: 100px;
            overflow-y: auto;
            border: 1px solid #fecaca;
        }

        .product-list-title {
            font-weight: 600;
            color: #991b1b;
            font-size: 10px;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .product-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px;
            margin: 3px 0;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #dc2626;
            font-size: 11px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .product-item-info {
            display: flex;
            justify-content: space-between;
            flex: 1;
        }

        .product-item span:first-child {
            font-weight: 600;
            color: #374151;
        }

        .product-item span:last-child {
            color: #dc2626;
            font-weight: bold;
        }

        .remove-product-btn {
            background: none;
            border: none;
            color: #dc2626;
            cursor: pointer;
            font-size: 14px;
            padding: 0 5px;
            transition: transform 0.2s;
        }

        .remove-product-btn:hover {
            transform: scale(1.2);
        }

        .records-info {
            text-align: center;
            color: white;
            font-weight: 600;
            margin-top: 8px;
            font-size: 10px;
            background: rgba(220, 38, 38, 0.9);
            padding: 5px;
            border-radius: 6px;
        }

        .product-hint {
            font-size: 9px;
            color: #991b1b;
            margin-top: 2px;
            font-style: italic;
        }

        /* Optimized for 800x480 screens */
        @media (max-width: 800px) and (max-height: 480px) {
            body {
                padding: 5px;
            }

            .container {
                max-height: 95vh;
            }

            .header {
                padding: 6px 10px;
            }

            .logo {
                height: 25px;
            }

            .app-title {
                font-size: 15px;
            }

            .content {
                padding: 8px;
            }

            .form-group {
                margin-bottom: 6px;
            }

            label {
                font-size: 10px;
            }

            input[type="text"] {
                padding: 6px;
                font-size: 12px;
            }

            .count-display {
                padding: 6px 10px;
            }

            .count-value {
                font-size: 20px;
            }

            .btn {
                padding: 8px;
                font-size: 12px;
            }

            .product-list {
                max-height: 80px;
            }
        }

        /* Touch-friendly */
        @media (hover: none) and (pointer: coarse) {
            .btn, input[type="text"] {
                min-height: 44px;
            }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #fef2f2;
        }

        ::-webkit-scrollbar-thumb {
            background: #dc2626;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #b91c1c;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Settings Sidebar -->
    <div class="settings-sidebar" id="settingsSidebar">
        <div class="settings-header">
            <div class="settings-title">Param√®tres</div>
            <button class="close-settings" id="closeSettings">√ó</button>
        </div>

        <!-- Branding Section -->
        <div class="settings-section">
            <div class="settings-section-title">Branding</div>
            <div class="settings-field">
                <label>Logo URL</label>
                <input type="url" id="logoUrl" placeholder="https://exemple.com/logo.png">
            </div>
            <div class="settings-field">
                <label>Nom de l'application</label>
                <input type="text" id="appName" placeholder="EasyInv">
            </div>
        </div>

        <!-- Export Configuration -->
        <div class="settings-section">
            <div class="settings-section-title">Export √† Distance</div>
            <div class="settings-field">
                <label>Serveur d'export</label>
                <input type="text" id="exportServer" placeholder="exportServ:8010">
            </div>
        </div>

        <!-- Fields Management -->
        <div class="settings-section">
            <div class="settings-section-title">Champs de Localisation</div>
            <div class="checkbox-group">
                <input type="checkbox" id="enableSite" checked>
                <label for="enableSite">Site</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="enableFloor" checked>
                <label for="enableFloor">√âtage</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="enableRoom" checked>
                <label for="enableRoom">Salle</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="enableShelf" checked>
                <label for="enableShelf">√âtag√®re</label>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="logo-container">
                <img src="https://scantech-group.com/wp-content/uploads/2024/10/SG_logo_RVB-01.png" alt="Logo" class="logo" id="appLogo">
                <span class="app-title" id="appTitle">EasyInv</span>
            </div>
            <div class="header-buttons">
                <button class="settings-btn" id="settingsBtn">‚öôÔ∏è</button>
                <button class="fullscreen-btn" id="fullscreenBtn">üñ•Ô∏è</button>
            </div>
        </div>

        <div class="content">
            <form id="inventoryForm">
                <div class="form-row" id="siteFloorRow">
                    <div class="form-group" id="siteGroup">
                        <label for="site">Site</label>
                        <input type="text" id="site" name="site" value="NULL">
                    </div>

                    <div class="form-group" id="floorGroup">
                        <label for="floor">√âtage</label>
                        <input type="text" id="floor" name="floor" value="NULL">
                    </div>
                </div>

                <div class="form-row" id="roomShelfRow">
                    <div class="form-group" id="roomGroup">
                        <label for="room">Salle</label>
                        <input type="text" id="room" name="room" value="NULL">
                    </div>

                    <div class="form-group" id="shelfGroup">
                        <label for="shelf">√âtag√®re</label>
                        <input type="text" id="shelf" name="shelf" value="NULL">
                    </div>
                </div>

                <div class="form-group">
                    <label for="product">Code-barres Produit</label>
                    <input type="text" id="product" name="product" placeholder="Scanner le code-barres">
                    <div class="product-hint">Scanner les produits en continu - sauvegarde auto</div>
                </div>

                <div class="count-display">
                    <div class="count-label">Produits dans cette localisation</div>
                    <div class="count-value" id="productCount">0</div>
                </div>

                <div class="current-location" id="currentLocation">
                    <strong>Localisation actuelle :</strong> Non d√©finie
                </div>

                <div class="product-list" id="productList" style="display: none;">
                    <div class="product-list-title">Produits scann√©s :</div>
                    <div id="productItems"></div>
                </div>

                <button type="button" class="btn btn-primary" id="saveBtn">Enregistrer & Suivant</button>
                <button type="button" class="btn btn-secondary" id="exportBtn">Exporter l'inventaire</button>
                <div class="records-info" id="recordsInfo">0 enregistrement sauvegard√©</div>
            </form>
        </div>
    </div>

    <script>
        let inventoryRecords = [];
        let currentLocation = {
            site: '',
            floor: '',
            room: '',
            shelf: ''
        };
        let productScans = {};
        let lastScannedProduct = '';
        
        // Settings
        let settings = {
            logoUrl: 'https://scantech-group.com/wp-content/uploads/2024/10/SG_logo_RVB-01.png',
            appName: 'EasyInv',
            exportServer: '',
            enableSite: true,
            enableFloor: true,
            enableRoom: true,
            enableShelf: true
        };

        // Load settings from localStorage
        function loadSettings() {
            const saved = localStorage.getItem('easyinv-settings');
            if (saved) {
                settings = { ...settings, ...JSON.parse(saved) };
                applySettings();
            }
        }

        // Save settings to localStorage
        function saveSettings() {
            localStorage.setItem('easyinv-settings', JSON.stringify(settings));
            applySettings();
        }

        // Apply settings to UI
        function applySettings() {
            document.getElementById('appLogo').src = settings.logoUrl;
            document.getElementById('appTitle').textContent = settings.appName;
            document.getElementById('logoUrl').value = settings.logoUrl;
            document.getElementById('appName').value = settings.appName;
            document.getElementById('exportServer').value = settings.exportServer;
            document.getElementById('enableSite').checked = settings.enableSite;
            document.getElementById('enableFloor').checked = settings.enableFloor;
            document.getElementById('enableRoom').checked = settings.enableRoom;
            document.getElementById('enableShelf').checked = settings.enableShelf;

            // Show/hide fields
            document.getElementById('siteGroup').classList.toggle('hidden', !settings.enableSite);
            document.getElementById('floorGroup').classList.toggle('hidden', !settings.enableFloor);
            document.getElementById('roomGroup').classList.toggle('hidden', !settings.enableRoom);
            document.getElementById('shelfGroup').classList.toggle('hidden', !settings.enableShelf);

            updateFieldsArray();
        }

        // Get active fields
        function getActiveFields() {
            const active = [];
            if (settings.enableSite) active.push('site');
            if (settings.enableFloor) active.push('floor');
            if (settings.enableRoom) active.push('room');
            if (settings.enableShelf) active.push('shelf');
            active.push('product');
            return active;
        }

        let fields = getActiveFields();

        function updateFieldsArray() {
            fields = getActiveFields();
            setupFieldHandlers();
        }

        // Settings sidebar toggle
        document.getElementById('settingsBtn').addEventListener('click', () => {
            document.getElementById('settingsSidebar').classList.add('open');
        });

        document.getElementById('closeSettings').addEventListener('click', () => {
            document.getElementById('settingsSidebar').classList.remove('close');
        });

        // Settings inputs
        document.getElementById('logoUrl').addEventListener('change', (e) => {
            settings.logoUrl = e.target.value;
            saveSettings();
        });

        document.getElementById('appName').addEventListener('change', (e) => {
            settings.appName = e.target.value;
            saveSettings();
        });

        document.getElementById('exportServer').addEventListener('change', (e) => {
            settings.exportServer = e.target.value;
            saveSettings();
        });

        document.getElementById('enableSite').addEventListener('change', (e) => {
            settings.enableSite = e.target.checked;
            saveSettings();
        });

        document.getElementById('enableFloor').addEventListener('change', (e) => {
            settings.enableFloor = e.target.checked;
            saveSettings();
        });

        document.getElementById('enableRoom').addEventListener('change', (e) => {
            settings.enableRoom = e.target.checked;
            saveSettings();
        });

        document.getElementById('enableShelf').addEventListener('change', (e) => {
            settings.enableShelf = e.target.checked;
            saveSettings();
        });

        // Close settings when clicking outside
        document.addEventListener('click', (e) => {
            const sidebar = document.getElementById('settingsSidebar');
            const settingsBtn = document.getElementById('settingsBtn');
            
            if (sidebar.classList.contains('open') && 
                !sidebar.contains(e.target) && 
                e.target !== settingsBtn) {
                sidebar.classList.remove('open');
            }
        });

        // Update current location display
        function updateLocationDisplay() {
            const locationEl = document.getElementById('currentLocation');
            const parts = [];
            if (settings.enableSite && currentLocation.site) parts.push(currentLocation.site);
            if (settings.enableFloor && currentLocation.floor) parts.push(currentLocation.floor);
            if (settings.enableRoom && currentLocation.room) parts.push(currentLocation.room);
            if (settings.enableShelf && currentLocation.shelf) parts.push(currentLocation.shelf);
            
            if (parts.length > 0) {
                locationEl.innerHTML = `<strong>Localisation actuelle :</strong> ${parts.join(' ‚Üí ')}`;
            } else {
                locationEl.innerHTML = '<strong>Localisation actuelle :</strong> Non d√©finie';
            }
        }

        // Remove product from scan list
        function removeProduct(barcode) {
            if (productScans[barcode]) {
                delete productScans[barcode];
                updateProductList();
            }
        }

        // Update product list display
        function updateProductList() {
            const productListEl = document.getElementById('productList');
            const productItemsEl = document.getElementById('productItems');
            const totalCount = Object.values(productScans).reduce((sum, count) => sum + count, 0);
            
            document.getElementById('productCount').textContent = totalCount;

            if (Object.keys(productScans).length > 0) {
                productListEl.style.display = 'block';
                productItemsEl.innerHTML = '';
                
                for (const [barcode, count] of Object.entries(productScans)) {
                    const item = document.createElement('div');
                    item.className = 'product-item';
                    item.innerHTML = `
                        <div class="product-item-info">
                            <span>${barcode}</span>
                            <span>√ó${count}</span>
                        </div>
                        <button class="remove-product-btn" onclick="removeProduct('${barcode}')">‚ùå</button>
                    `;
                    productItemsEl.appendChild(item);
                }
            } else {
                productListEl.style.display = 'none';
            }
        }

        // Check if location has changed
        function hasLocationChanged() {
            const site = settings.enableSite ? document.getElementById('site').value : '';
            const floor = settings.enableFloor ? document.getElementById('floor').value : '';
            const room = settings.enableRoom ? document.getElementById('room').value : '';
            const shelf = settings.enableShelf ? document.getElementById('shelf').value : '';

            return site !== currentLocation.site || 
                   floor !== currentLocation.floor || 
                   room !== currentLocation.room || 
                   shelf !== currentLocation.shelf;
        }

        // Save current location to records
        function saveCurrentLocation() {
            const hasRequiredFields = 
                (!settings.enableSite || currentLocation.site) &&
                (!settings.enableFloor || currentLocation.floor) &&
                (!settings.enableRoom || currentLocation.room) &&
                (!settings.enableShelf || currentLocation.shelf);

            if (!hasRequiredFields) {
                return;
            }

            if (Object.keys(productScans).length === 0) {
                return;
            }

            // Create a record for each product with its count
            for (const [barcode, count] of Object.entries(productScans)) {
                const record = {
                    timestamp: new Date().toISOString(),
                    productBarcode: barcode,
                    quantity: count
                };

                if (settings.enableSite) record.site = currentLocation.site;
                if (settings.enableFloor) record.floor = currentLocation.floor;
                if (settings.enableRoom) record.room = currentLocation.room;
                if (settings.enableShelf) record.shelf = currentLocation.shelf || 'NULL';

                inventoryRecords.push(record);
            }

            // Update records count
            const count = inventoryRecords.length;
            document.getElementById('recordsInfo').textContent = `${count} enregistrement${count > 1 ? 's' : ''} sauvegard√©${count > 1 ? 's' : ''}`;
        }

        // Setup field handlers
        function setupFieldHandlers() {
            const activeFields = getActiveFields();
            
            activeFields.forEach((fieldId, index) => {
                const input = document.getElementById(fieldId);
                if (!input) return;

                // Remove old listeners by cloning
                const newInput = input.cloneNode(true);
                input.parentNode.replaceChild(newInput, input);

                // Clear field on focus and select all (overwrite behavior for all fields)
                newInput.addEventListener('focus', (e) => {
                    if (fieldId !== 'product' && e.target.value === 'NULL') {
                        e.target.value = '';
                    }
                    // Select all text so next input overwrites completely
                    setTimeout(() => e.target.select(), 10);
                });

                // Only restore NULL on blur for location fields, NOT for product field
                if (fieldId !== 'product') {
                    newInput.addEventListener('blur', (e) => {
                        if (e.target.value.trim() === '') {
                            e.target.value = 'NULL';
                        }
                    });
                }
                
                newInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        
                        if (fieldId === 'product') {
                            const barcode = newInput.value.trim();
                            
                            if (barcode === '' || barcode === 'NULL') {
                                return;
                            }

                            // Check if required location fields are filled
                            const site = settings.enableSite ? document.getElementById('site').value : 'NULL';
                            const floor = settings.enableFloor ? document.getElementById('floor').value : 'NULL';
                            const room = settings.enableRoom ? document.getElementById('room').value : 'NULL';
                            const shelf = settings.enableShelf ? document.getElementById('shelf').value : 'NULL';

                            const hasRequiredFields = 
                                (!settings.enableSite || (site && site !== 'NULL')) &&
                                (!settings.enableFloor || (floor && floor !== 'NULL')) &&
                                (!settings.enableRoom || (room && room !== 'NULL')) &&
                                (!settings.enableShelf || (shelf && shelf !== 'NULL'));

                            if (!hasRequiredFields) {
                                alert('Veuillez remplir tous les champs de localisation actifs avant de scanner les produits');
                                return;
                            }

                            // If location has changed, save previous location and reset
                            if (hasLocationChanged()) {
                                saveCurrentLocation();
                                
                                // Update current location
                                currentLocation.site = site;
                                currentLocation.floor = floor;
                                currentLocation.room = room;
                                currentLocation.shelf = shelf;
                                
                                // Reset product scans
                                productScans = {};
                                
                                updateLocationDisplay();
                            }

                            // Add or increment product count
                            if (productScans[barcode]) {
                                productScans[barcode]++;
                            } else {
                                productScans[barcode] = 1;
                            }

                            lastScannedProduct = barcode;
                            updateProductList();
                            
                            // Clear input for next scan and select it
                            newInput.value = '';
                            setTimeout(() => newInput.select(), 10);
                        } else {
                            // For location fields, move to next field automatically
                            if (index < activeFields.length - 1) {
                                const nextFieldId = activeFields[index + 1];
                                const nextField = document.getElementById(nextFieldId);
                                if (nextField) {
                                    nextField.focus();
                                    // Select all for immediate overwrite
                                    setTimeout(() => nextField.select(), 10);
                                }
                            }
                        }
                    }
                });

                // Enhanced auto-tabulation with better barcode detection
                if (fieldId !== 'product') {
                    let scanBuffer = '';
                    let scanTimeout = null;
                    
                    newInput.addEventListener('input', (e) => {
                        const value = e.target.value.trim();
                        
                        // Clear previous timeout
                        if (scanTimeout) {
                            clearTimeout(scanTimeout);
                        }
                        
                        // Barcode scanners type very fast (usually < 50ms between characters)
                        // If we get 4+ characters, assume it's a scan
                        if (value.length >= 4 && value !== 'NULL') {
                            scanTimeout = setTimeout(() => {
                                // Auto-tab after short delay to ensure scan is complete
                                if (value.length >= 4) {
                                    const enterEvent = new KeyboardEvent('keydown', {
                                        key: 'Enter',
                                        code: 'Enter',
                                        keyCode: 13,
                                        which: 13,
                                        bubbles: true
                                    });
                                    e.target.dispatchEvent(enterEvent);
                                }
                            }, 150); // Increased delay to ensure full scan
                        }
                    });
                }

                // For product field, auto-process with same enhanced detection
                if (fieldId === 'product') {
                    let productScanTimeout = null;
                    
                    newInput.addEventListener('input', (e) => {
                        const value = e.target.value.trim();
                        
                        if (productScanTimeout) {
                            clearTimeout(productScanTimeout);
                        }
                        
                        if (value.length >= 4) {
                            productScanTimeout = setTimeout(() => {
                                if (value.length >= 4) {
                                    const enterEvent = new KeyboardEvent('keydown', {
                                        key: 'Enter',
                                        code: 'Enter',
                                        keyCode: 13,
                                        which: 13,
                                        bubbles: true
                                    });
                                    e.target.dispatchEvent(enterEvent);
                                }
                            }, 150);
                        }
                    });
                }
            });
        }

        // Handle Save & Move to Next Location button
        document.getElementById('saveBtn').addEventListener('click', () => {
            const site = settings.enableSite ? document.getElementById('site').value : 'NULL';
            const floor = settings.enableFloor ? document.getElementById('floor').value : 'NULL';
            const room = settings.enableRoom ? document.getElementById('room').value : 'NULL';
            const shelf = settings.enableShelf ? document.getElementById('shelf').value : 'NULL';

            const hasRequiredFields = 
                (!settings.enableSite || (site && site !== 'NULL')) &&
                (!settings.enableFloor || (floor && floor !== 'NULL')) &&
                (!settings.enableRoom || (room && room !== 'NULL')) &&
                (!settings.enableShelf || (shelf && shelf !== 'NULL'));

            if (!hasRequiredFields) {
                alert('Veuillez remplir tous les champs de localisation actifs');
                return;
            }

            // Update current location if changed
            if (hasLocationChanged()) {
                saveCurrentLocation();
                
                currentLocation.site = site;
                currentLocation.floor = floor;
                currentLocation.room = room;
                currentLocation.shelf = shelf;
            }

            // Save current location
            saveCurrentLocation();

            const totalProducts = Object.values(productScans).reduce((sum, count) => sum + count, 0);
            
            const locationParts = [];
            if (settings.enableSite && site && site !== 'NULL') locationParts.push(site);
            if (settings.enableFloor && floor && floor !== 'NULL') locationParts.push(floor);
            if (settings.enableRoom && room && room !== 'NULL') locationParts.push(room);
            if (settings.enableShelf && shelf && shelf !== 'NULL') locationParts.push(shelf);
            
            alert(`Localisation enregistr√©e !\n\n${locationParts.join(' ‚Üí ')}\n\nTotal produits scann√©s : ${totalProducts}`);
            
            // Reset for next location - set all fields back to NULL
            if (settings.enableSite) document.getElementById('site').value = 'NULL';
            if (settings.enableFloor) document.getElementById('floor').value = 'NULL';
            if (settings.enableRoom) document.getElementById('room').value = 'NULL';
            if (settings.enableShelf) document.getElementById('shelf').value = 'NULL';
            document.getElementById('product').value = 'NULL';
            
            productScans = {};
            currentLocation = { site: '', floor: '', room: '', shelf: '' };
            lastScannedProduct = '';
            
            updateLocationDisplay();
            updateProductList();
            document.getElementById('productCount').textContent = '0';
            
            // Focus on first enabled field
            const firstField = getActiveFields()[0];
            if (firstField && firstField !== 'product') {
                document.getElementById(firstField).focus();
            }
        });

        // Handle Export button
        document.getElementById('exportBtn').addEventListener('click', () => {
            if (inventoryRecords.length === 0) {
                alert('Aucun enregistrement √† exporter. Veuillez ajouter des enregistrements d\'inventaire d\'abord.');
                return;
            }

            // Build headers based on enabled fields (in English)
            const headers = [];
            headers.push('Timestamp');
            if (settings.enableSite) headers.push('Site');
            if (settings.enableFloor) headers.push('Floor');
            if (settings.enableRoom) headers.push('Room');
            if (settings.enableShelf) headers.push('Shelf');
            headers.push('Product_Barcode');
            headers.push('Quantity');

            const csvRows = [headers.join(',')];

            inventoryRecords.forEach(record => {
                const row = [];
                row.push(`"${record.timestamp}"`);
                if (settings.enableSite) row.push(`"${record.site || 'NULL'}"`);
                if (settings.enableFloor) row.push(`"${record.floor || 'NULL'}"`);
                if (settings.enableRoom) row.push(`"${record.room || 'NULL'}"`);
                if (settings.enableShelf) row.push(`"${record.shelf || 'NULL'}"`);
                row.push(`"${record.productBarcode}"`);
                row.push(record.quantity);
                csvRows.push(row.join(','));
            });

            const csvContent = csvRows.join('\n');

            // Create blob and download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const date = new Date().toISOString().split('T')[0];
            const filename = `inventory_export_${date}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            alert(`${inventoryRecords.length} enregistrement${inventoryRecords.length > 1 ? 's' : ''} export√©${inventoryRecords.length > 1 ? 's' : ''} vers ${filename}`);
        });

        // Fullscreen/Kiosk mode functionality
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        
        fullscreenBtn.addEventListener('click', () => {
            if (!document.fullscreenElement) {
                const elem = document.documentElement;
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                } else if (elem.mozRequestFullScreen) {
                    elem.mozRequestFullScreen();
                } else if (elem.msRequestFullscreen) {
                    elem.msRequestFullscreen();
                }
                
                fullscreenBtn.classList.add('active');
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                
                fullscreenBtn.classList.remove('active');
            }
        });

        // Update button if fullscreen is exited
        document.addEventListener('fullscreenchange', updateFullscreenButton);
        document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
        document.addEventListener('mozfullscreenchange', updateFullscreenButton);
        document.addEventListener('msfullscreenchange', updateFullscreenButton);

        function updateFullscreenButton() {
            const isFullscreen = document.fullscreenElement || 
                                document.webkitFullscreenElement || 
                                document.mozFullScreenElement || 
                                document.msFullscreenElement;
            
            if (!isFullscreen) {
                fullscreenBtn.classList.remove('active');
            }
        }

        // Prevent zoom on double-tap
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (e) => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // Register Service Worker for PWA (only if not in iframe/artifact)
        if ('serviceWorker' in navigator && window.location.hostname !== 'www.claudeusercontent.com') {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => {
                        console.log('Service Worker enregistr√©:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('√âchec enregistrement Service Worker:', error);
                    });
            });
        }

        // Initialize
        loadSettings();
        setupFieldHandlers();
        
        // Focus on first enabled field
        const firstField = getActiveFields()[0];
        if (firstField && firstField !== 'product') {
            document.getElementById(firstField).focus();
        }
    </script>
</body>
</html>
